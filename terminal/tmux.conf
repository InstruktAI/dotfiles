# Prefix: C-a
set -g prefix C-a
unbind C-b
bind C-a send-prefix

set -g base-index 1
setw -g pane-base-index 1
set -g mouse on
set -g history-limit 50000
setw -g mode-keys vi
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"
set -s escape-time 0

bind r source-file ~/.tmux.conf \; display "Reloaded"
bind R run-shell 'session="#{session_name}"; cmd=$(ps -o args= -p #{pane_pid} 2>/dev/null); if echo "$cmd" | grep -q "tmux.*attach.*-t"; then inner=$(echo "$cmd" | sed -n "s/.*-t *\\([^ ]*\\).*/\\1/p"); [ -n "$inner" ] && session="$inner"; fi; curl -s -X POST --unix-socket /tmp/teleclaude-api.sock "http://localhost/sessions/tmux/$session/agent-restart" >/dev/null 2>&1 && tmux display-message "Agent restarting ($session)..." || tmux display-message "Restart failed ($session)"'
bind v split-window -h -c "#{pane_current_path}"
bind S split-window -v -c "#{pane_current_path}"
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-selection-and-cancel
bind -T copy-mode-vi MouseDragEnd1Pane send -X copy-selection-and-cancel
bind -T copy-mode-vi DoubleClick1Pane select-pane \; send -X select-word \; run-shell -d 0.3 \; send -X copy-selection-and-cancel
bind -T copy-mode-vi TripleClick1Pane select-pane \; send -X select-line \; run-shell -d 0.3 \; send -X copy-selection-and-cancel
bind -n MouseDrag1Pane copy-mode -M
bind -n MouseDrag1Pane copy-mode -M

set -g pane-border-indicators off
set -g focus-events on

# Focus hook for inner session dimming (tc_tui only)
set-hook -g after-select-pane 'if -F "#{==:#{session_name},tc_tui}" "run-shell \"~/.local/bin/appearance focus-pane #{pane_pid}\""'

# Ensure inner tc_* sessions render cleanly when attached (except tc_tui)
set-hook -g client-attached 'run-shell "session=#{session_name}; if [[ $session =~ ^tc_[a-f0-9]+$ ]]; then tmux set -t $session status-right \"\" \\; set -t $session status-right-length 0 \\; set -t $session status-left-length 40; fi"'
set-hook -g client-session-changed 'run-shell "session=#{session_name}; if [[ $session =~ ^tc_[a-f0-9]+$ ]]; then tmux set -t $session status-right \"\" \\; set -t $session status-right-length 0 \\; set -t $session status-left-length 40; fi"'
set-hook -g session-created 'run-shell "session=#{session_name}; if [[ $session =~ ^tc_[a-f0-9]+$ ]]; then tmux set -t $session status-right \"\" \\; set -t $session status-right-length 0 \\; set -t $session status-left-length 40; fi"'

# Generate and load theme
run-shell "~/.local/bin/appearance tmux-theme"
source-file /tmp/tmux-theme.conf

# Full screen toggle
bind z resize-pane -Z
# Save layout before maximizing
bind w run-shell -b 'tmux display-message -p "#{window_layout}" > /tmp/tmux-layout && tmux resize-pane -y 999'
# Restore saved layout
bind s run-shell -b 'tmux select-layout "$(cat /tmp/tmux-layout)"'